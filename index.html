<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body,h1, h2, h3, h4, h5, h6 {
            font-family: Arial, Helvetica, sans-serif;
        }

        * {
            box-sizing: border-box;
        }

       
        /* The popup form - hidden by default */
        .form-popup {
            position: fixed;
            bottom: 0;
            right: 15px;
            border: 3px solid #f1f1f1;
            z-index: 9;
        }

        /* Add styles to the form container */
        .form-container {
            width: 300px;
            padding: 10px;
            background-color: white;
        }

      

    </style>
</head>

<body>


    <div class="form-popup">

        <form class="form-container" id="myForm">
            <h2>Onbaoding</h2>
            <br />

            <label for="email"><b>Host</b></label>
            <div>
                <select class="w3-select  w3-border w3-light-grey" id="baseurl">
                    <option value="1" disabled>Select Host</option>
                    <option value="https://bagher-api.vusionrail.com">bagher</option>
                    <option value="2">Option 2</option>
                    <option value="3">Option 3</option>
                  </select>
            </div>
            <br/>
            <label for="email"><b>StoreId</b></label>
            <input type="text" class="w3-input w3-border w3-light-grey" placeholder="Enter StoreId" id="storeid" required>
            <br/>
            <label for="psw"><b>API Key</b></label>
            <input type="password" class="w3-input w3-border w3-light-grey"placeholder="Enter API Key" id="apikey" required>
<br/>
            <button class="w3-btn w3-green w3-block" type="submit" class="btn">Onboard</button>
            <br/>

            <button class="w3-btn w3-red w3-block" id="logout" onclick="Logout()">Logout</button>
        </form>
    </div>

    <script>

    </script>
    <script>

            var value ="123";
            const hexValue = stringToHexString(value);
            const hexLength = value.length.toString(16).padStart(2, '0');
            const fullValue = `2${hexLength}${hexValue}`.toLowerCase();

            // Convert hex string to byte array
            const data = hexStringToByteArray(fullValue);

            console.log(fullValue);
   
        function Logout(){
            document.getElementById('storeid').value = null;
            document.getElementById('apikey').value = null;
            document.getElementById('baseurl').value = null;
            document.getElementById("logout").style.display = "none";
            localStorage.clear();
        }
        
        const storeid = localStorage.getItem('storeid');
        const apikey = localStorage.getItem('apikey');
        const baseurl = localStorage.getItem('baseurl');
       
        document.getElementById('storeid').value = storeid;
        document.getElementById('apikey').value = apikey;
        document.getElementById('baseurl').value = baseurl;

        if(apikey!= null && apikey.length >1){
            document.getElementById("logout").style.display = "block";
        }else{
            document.getElementById("logout").style.display = "none";
        }
        document.getElementById('myForm').addEventListener('submit', async function (event) {
            event.preventDefault(); // Prevent the default form submission

            const baseurl = document.getElementById('baseurl').value;
            const storeid = document.getElementById('storeid').value;
            const apikey = document.getElementById('apikey').value;

            console.log(baseurl);
            localStorage.setItem('baseurl', baseurl);
            localStorage.setItem('storeid', storeid);
            localStorage.setItem('apikey', apikey);
          
            document.getElementById("logout").style.display = "block";
            await Register();
            // Here you can send data to a server or perform other actions
        });


        async function Register() {

   
                document.getElementById("myForm").style.display = "none";








const baseUrl = document.getElementById('baseurl').value;
const storeid = document.getElementById('storeid').value;
const apikey = document.getElementById('apikey').value;

// const deviceid = document.getElementById('deviceid').value;
// const devicekey = document.getElementById('devicekey').value;
// const iothub = document.getElementById('iothub').value;







                try{
const device = await navigator.bluetooth.requestDevice({
                filters: [{ services: ['000018aa-0000-1000-8000-00805f9b34fb'] }],
                optionalServices: ['00002aaa-0000-1000-8000-00805f9b34fb'],
                acceptAllDevices: false
                    });


            const server = await device.gatt.connect();

            // Access the service
            const service = await server.getPrimaryService('000018aa-0000-1000-8000-00805f9b34fb');


            // Access the characteristic
            const characteristic = await service.getCharacteristic('00002aaa-0000-1000-8000-00805f9b34fb');

            // Check if the characteristic supports indication
            if (characteristic.properties.indicate) {
                await characteristic.startNotifications();
                console.log("startNotifications!");

                characteristic.addEventListener('characteristicvaluechanged', (event) => {
                    const value = event.target.value;
                    console.log('Notification received: ', value);
                    // Handle incoming notification data
                });

                console.log('Started listening for indications.');
            } else {
                console.log('Characteristic does not support indication.');
            }


            // Sending data to the device
            await setCharacteristic1(characteristic, '01', 'navid123');

            await setCharacteristic1(characteristic, '02', 'navid123');

            await setCharacteristic2(characteristic, '03', 2, '0708');  // Length 2, custom value

            await setCharacteristic1(characteristic, '04', 'ep-1ad032-413b338b13cc24f2-841168d810a83e3c');

            await setCharacteristic1(characteristic, '05', 'vrail-han-devices-iot.azure-devices.net');

            await setCharacteristic1(characteristic, '06', 'A8xMGlqlqg+XBemDB36cdkQXosPnOQY969dbElFhS+w=');

            alert("Onboarded");
         }
            catch (error) {
                alert(error);
            
            }finally{
                document.getElementById("myForm").style.display = "block";
            }
        
































return;





const url = 'https://bagher-api.vusionrail.com/v1/stores/poster32/devices/ads-epd-ce4678/register';
const headers = {
    'Content-Type': 'application/json',
    'Ocp-Apim-Subscription-Key': apikey,
};

console.log(headers);

const data = {
    pin: '0000',
    sync: {
        initialOffset: 0,
        interval: 0,
        intervalLimit: 0,
        battery: 0,
    },
};


























fetch(url, {
    method: 'POST',
    headers: headers,
    body: JSON.stringify(data),
})
.then(response => {
    if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
    }
    return response.json();
})
.then(data => {
    console.log('Success:', data);
})
.catch(error => {
    console.error('Error:', error);
});

        }





        function hexStringToByteArray(hex) {
    const byteArray = [];
    for (let i = 0; i < hex.length; i += 2) {
        byteArray.push(parseInt(hex.substr(i, 2), 16));
    }
    return new Uint8Array(byteArray);
}

function stringToHexString(value) {
    let hexString = '';
    for (const char of value) {
        hexString += char.charCodeAt(0).toString(16).padStart(2, '0');
    }
    return hexString.trim();
}

async function setCharacteristic1(setCharacteristic, type, value) {
    const hexLength = value.length.toString(16).padStart(2, '0');
    const hexValue = stringToHexString(value);
    return await setCharacteristic3(setCharacteristic, (type + hexLength + hexValue).toLowerCase());
}

async function setCharacteristic2(setCharacteristic, type, length, hexValue) {
    const hexLength = length.toString(16).padStart(2, '0');
    return await setCharacteristic3(setCharacteristic, (type + hexLength + hexValue).toLowerCase());
}

async function setCharacteristic3(setCharacteristic, hexValue) {
    const data = hexStringToByteArray(hexValue);

    try {
        const res = await setCharacteristic.writeAsync(data, { signal: controller.signal });
        return res;
    } catch (error) {
        return false; // Handle error accordingly
    }
}


    </script>

</body>

</html>
